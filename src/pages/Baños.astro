---
import CardProductos from "@/components/car/CardProductos.astro";
import Layout from "../layouts/Layout.astro";
import { getProductos } from "../services/productos";
import type { ApiResponse } from "@/types/types";
import { obtenerMarcasUnicas } from "@/utils/MarcasUnicas";
import { subcategoriasUnicas } from "@/utils/subcategoriasUnicas";

const dataresponse: ApiResponse = await getProductos("categorias", "baños");
const marcasUnicas = obtenerMarcasUnicas(dataresponse.productos);
const categoriasUnicas = subcategoriasUnicas(dataresponse.productos);
---

<Layout title="Baños">
  <section
    class="w-full px-3 mx-auto flex flex-col md:grid gap-1 md:gap-2"
    id="container">
    <aside class="px-2 md:px-5 hidden md:flex">
      <div class="mt-2 w-full">
        <h2 class="text-xl font-semibold">BAÑOS</h2>
        <span class="text-gray-500 uppercase text-[12px] mb-2">Filtros*</span>
        <div class="w-full bg-[#ececec] py-3 flex justify-start px-2">
          <h3 class="text-[18px]">Categorías</h3>
        </div>
        <div class="pl-3 uppercase">
          {
            categoriasUnicas.map((categoria) => (
              <ul>
                <li>
                  <input
                    class="m-2 rounded-[3px] w-3 h-3 focus:ring-2"
                    type="checkbox"
                    name="categoria"
                    value={categoria}
                    id={categoria}
                  />
                  <label for={categoria}>{categoria}</label>
                </li>
              </ul>
            ))
          }
        </div>
        <div class="w-full bg-[#ececec] py-3 flex justify-start px-2">
          <h3 class="text-[18px]">Marcas</h3>
        </div>
        <div class="pl-3 uppercase">
          {
            marcasUnicas.map((marca) => (
              <ul>
                <li>
                  <input
                    class="m-2 rounded-[3px] w-3 h-3 focus:ring-2"
                    type="checkbox"
                    name="marca"
                    value={marca}
                    id={marca}
                  />
                  <label for={marca}>{marca}</label>
                </li>
              </ul>
            ))
          }
        </div>
      </div>
    </aside>
    <section class="flex w-full flex-wrap p-2 justify-center flex-col">
      <span
        class="text-sm md:text-base font-light uppercase mb-3"
        id="no-productos">
        {dataresponse.productos.length} Productos
      </span>
      <div
        id="mensaje-no-productos"
        class="w-full justify-center text-xl items-center text-red-500 font-semibold hidden text-center">
        No hay productos disponibles.
      </div>
      <div class="w-full gap-x-2 gap-y-2 md:gap-8 flex flex-wrap">
        {
          dataresponse.productos.map((producto) => (
            <CardProductos
              img={producto.image}
              precio={producto.valor}
              ref={producto.referencia}
              texto={producto.nombre}
              titulo={producto.marca}
              marca={producto.marca}
              categoria={producto.subcategoria.nombre}
            />
          ))
        }
      </div>
    </section>

    <script type="module">
      document.addEventListener("DOMContentLoaded", () => {
        const filtroMarcas = document.querySelectorAll('input[name="marca"]');
        const filtroCategorias = document.querySelectorAll(
          'input[name="categoria"]'
        );
        const productos = document.querySelectorAll(".card-producto");
        const mensajeNoProductos = document.querySelector(
          "#mensaje-no-productos"
        );
        const cantidadProducto = document.getElementById("no-productos");

        function aplicarFiltros() {
          const marcasSeleccionadas = Array.from(filtroMarcas)
            .filter((input) => input.checked)
            .map((input) => input.value);
          const categoriasSeleccionadas = Array.from(filtroCategorias)
            .filter((input) => input.checked)
            .map((input) => input.value);

          let hayProductosVisibles = false;

          productos.forEach((producto) => {
            const marca = producto.getAttribute("data-marca");
            const categoria = producto.getAttribute("data-categoria");

            const mostrarProducto =
              (marcasSeleccionadas.length === 0 ||
                marcasSeleccionadas.includes(marca)) &&
              (categoriasSeleccionadas.length === 0 ||
                categoriasSeleccionadas.includes(categoria));

            producto.style.display = mostrarProducto ? "block" : "none";

            if (mostrarProducto) {
              hayProductosVisibles = true;
            }
          });

          mensajeNoProductos.style.display = hayProductosVisibles
            ? "none"
            : "block";

          cantidadProducto.style.display = hayProductosVisibles
            ? "block"
            : "none";
        }

        filtroMarcas.forEach((input) =>
          input.addEventListener("change", aplicarFiltros)
        );
        filtroCategorias.forEach((input) =>
          input.addEventListener("change", aplicarFiltros)
        );

        // Inicializar estado del mensaje al cargar
        aplicarFiltros();
      });
    </script>

    <style>
      #container {
        grid-template-columns: 0.8fr 3fr;
      }
    </style>
  </section>
</Layout>
